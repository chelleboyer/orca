# Story 1.1: User Registration & Authentication System

**Epic:** Epic 1 - Foundation & Authentication Infrastructure  
**Status:** Approved  
**Assigned:** Developer Agent  
**Sprint:** Sprint 1  
**Story Points:** 8  

## User Story

As a **facilitator/team member**,  
I want **to register an account and securely log in**,  
so that **I can access the OOUX ORCA platform and maintain my project data securely**.

## Business Context

This story establishes the foundational authentication system for the OOUX ORCA Project Builder. Without secure user management, we cannot implement collaborative features, project ownership, or role-based access control. This story delivers immediate value by allowing users to create accounts and access the platform while setting up the security infrastructure for all subsequent features.

## Acceptance Criteria

### AC1: User Registration
- [ ] Users can register with email, password, and display name via `/register` endpoint
- [ ] Email validation ensures proper email format (RFC 5322 compliant)
- [ ] Password strength validation requires: minimum 8 characters, at least 1 uppercase, 1 lowercase, 1 number
- [ ] Display name validation: 2-50 characters, alphanumeric and spaces only
- [ ] Registration returns appropriate success/error responses with clear messaging
- [ ] Duplicate email registration returns specific error message

### AC2: Secure Authentication
- [ ] Users can log in with email/password combination via `/login` endpoint
- [ ] System uses Argon2 password hashing for secure credential storage
- [ ] Successful login returns JWT access token with 30-minute expiration
- [ ] Failed login attempts return generic error message (no username enumeration)
- [ ] Login endpoint implements rate limiting: max 5 attempts per minute per IP

### AC3: Session Management
- [ ] JWT tokens include user ID, email, and role claims
- [ ] Protected endpoints validate JWT tokens and return 401 for invalid/expired tokens
- [ ] Automatic logout redirects to login page when token expires
- [ ] `/logout` endpoint invalidates current session (token blacklisting)
- [ ] Session data stored in Redis with configurable TTL

### AC4: Password Reset Flow
- [ ] `/forgot-password` endpoint accepts email and sends reset link
- [ ] Password reset emails contain time-limited (15 minutes) secure token
- [ ] `/reset-password` endpoint validates reset token and updates password
- [ ] Reset tokens are single-use and invalidated after successful password change
- [ ] Password reset follows same validation rules as registration

### AC5: User Profile Management
- [ ] `/profile` endpoint returns current user information (email, name, created_at)
- [ ] Users can update display name via PATCH `/profile` endpoint
- [ ] Email updates require re-verification process
- [ ] Profile updates validate input and return appropriate error messages
- [ ] Profile history tracking for security audit purposes

## Technical Implementation Details

### Database Schema
```sql
-- Users table (based on architecture data models)
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    password_hash TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_login TIMESTAMP WITH TIME ZONE,
    is_active BOOLEAN DEFAULT TRUE,
    email_verified BOOLEAN DEFAULT FALSE,
    verification_token VARCHAR(255),
    reset_token VARCHAR(255),
    reset_token_expires TIMESTAMP WITH TIME ZONE
);

-- Indexes for performance
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_verification_token ON users(verification_token);
CREATE INDEX idx_users_reset_token ON users(reset_token);
```

### API Endpoints

#### POST /api/v1/auth/register
```json
// Request
{
  "email": "user@example.com",
  "password": "SecurePass123",
  "name": "John Doe"
}

// Response (201 Created)
{
  "id": "uuid",
  "email": "user@example.com",
  "name": "John Doe",
  "message": "Registration successful. Please check your email for verification."
}
```

#### POST /api/v1/auth/login
```json
// Request
{
  "email": "user@example.com", 
  "password": "SecurePass123"
}

// Response (200 OK)
{
  "access_token": "jwt_token_here",
  "token_type": "bearer",
  "expires_in": 1800,
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "John Doe"
  }
}
```

#### POST /api/v1/auth/logout
```json
// Response (200 OK)
{
  "message": "Successfully logged out"
}
```

#### POST /api/v1/auth/forgot-password
```json
// Request
{
  "email": "user@example.com"
}

// Response (200 OK)
{
  "message": "If an account exists, password reset instructions have been sent."
}
```

#### POST /api/v1/auth/reset-password
```json
// Request
{
  "token": "reset_token_here",
  "password": "NewSecurePass123"
}

// Response (200 OK)
{
  "message": "Password successfully reset"
}
```

#### GET /api/v1/auth/profile (Protected)
```json
// Response (200 OK)
{
  "id": "uuid",
  "email": "user@example.com",
  "name": "John Doe",
  "created_at": "2025-08-31T10:00:00Z",
  "last_login": "2025-08-31T14:30:00Z"
}
```

### Security Implementation

#### Authentication Flow
1. **Registration**: Hash password with Argon2, store user, send verification email
2. **Login**: Validate credentials, generate JWT token, store session in Redis
3. **Token Validation**: Middleware validates JWT on protected routes
4. **Session Management**: Redis stores active sessions with TTL
5. **Password Reset**: Generate secure token, send email, validate and reset

#### Security Measures
- **Password Hashing**: Argon2id with configurable memory/time parameters
- **JWT Configuration**: RS256 signing, short expiration, secure claims
- **Rate Limiting**: Implement on auth endpoints to prevent brute force
- **Input Validation**: Pydantic schemas for all request/response validation
- **CSRF Protection**: SameSite cookies for session management
- **SQL Injection Prevention**: SQLAlchemy ORM with parameterized queries

### File Structure
```
app/
├── models/
│   └── user.py                 # User SQLAlchemy model
├── schemas/
│   └── auth.py                 # Pydantic schemas for auth
├── api/v1/
│   └── auth.py                 # Authentication endpoints
├── services/
│   └── auth_service.py         # Authentication business logic
├── core/
│   ├── security.py             # JWT, password hashing utilities
│   └── email.py                # Email service for verification/reset
└── templates/auth/
    ├── login.html              # Login page template
    ├── register.html           # Registration page template
    └── forgot_password.html    # Password reset template
```

## Tasks for Development Agent

### Task 1: Database Models and Migrations
- [x] Create `app/models/user.py` with User SQLAlchemy model
- [x] Set up Alembic migration for users table
- [x] Add database indexes for performance
- [x] Create enum types for user roles/status

### Task 2: Authentication Schemas
- [x] Create `app/schemas/auth.py` with Pydantic models
- [x] Define request/response schemas for all auth endpoints
- [x] Add comprehensive validation rules and error messages
- [x] Include password strength validation schema

### Task 3: Security Infrastructure  
- [x] Implement `app/core/security.py` with JWT utilities
- [x] Add Argon2 password hashing functions
- [x] Create middleware for JWT token validation
- [x] Set up rate limiting for authentication endpoints

### Task 4: Authentication Service
- [x] Create `app/services/auth_service.py` with business logic
- [x] Implement user registration, login, logout functions
- [x] Add password reset and email verification logic
- [x] Create session management with Redis integration

### Task 5: API Endpoints
- [x] Implement all authentication endpoints in `app/api/v1/auth.py`
- [x] Add proper error handling and status codes
- [x] Integrate with authentication service layer
- [x] Add OpenAPI documentation tags and descriptions

### Task 6: Frontend Templates (Basic)
- [x] Create basic login/register HTML templates with HTMX
- [x] Add form validation and error display
- [x] Implement responsive design with Tailwind CSS
- [x] Create password reset flow templates

### Task 7: Testing Suite
- [x] Write unit tests for authentication service functions
- [x] Create integration tests for API endpoints
- [x] Add security testing for password hashing and JWT
- [x] Test rate limiting and validation edge cases

### Task 8: Configuration and Environment
- [x] Add authentication settings to app configuration
- [x] Set up email service configuration for password reset
- [x] Configure Redis connection for session management
- [x] Add environment variables for JWT secrets and email settings

## Definition of Done

- [ ] All acceptance criteria are implemented and tested
- [ ] Database migration successfully creates users table with indexes
- [ ] All API endpoints return documented responses and handle edge cases
- [ ] Security measures implemented: Argon2 hashing, JWT tokens, rate limiting
- [ ] Basic frontend templates allow user registration and login
- [ ] Email functionality works for password reset (using development email service)
- [ ] Comprehensive test suite covers all authentication flows
- [ ] Code follows project standards and passes linting
- [ ] API documentation is generated and accessible via `/docs`
- [ ] Manual testing confirms all user flows work end-to-end

## Dependencies
- **Database**: PostgreSQL connection established
- **Redis**: Redis connection for session management
- **Email Service**: SMTP configuration for password reset emails
- **Environment**: `.env` file with required authentication settings

## Technical Notes for Developer

### Database Connection
Use the existing `app/core/database.py` configuration. The User model should extend the Base class and include all necessary relationships for future stories.

### JWT Configuration
Implement JWT with RS256 algorithm using the SECRET_KEY from environment settings. Consider token refresh strategy for production deployment.

### Email Integration
For development, use console email backend. Production will require SMTP configuration. Design the email service to be easily configurable.

### Error Handling
Implement comprehensive error handling with appropriate HTTP status codes. Use FastAPI's exception handling to return consistent error responses.

### Rate Limiting
Use Redis-based rate limiting for authentication endpoints. Implement exponential backoff for repeated failed login attempts.

---

**Ready for Developer Agent Implementation**  
This story is fully specified and ready for development. The Developer Agent should implement tasks sequentially, maintaining test coverage and following the established project architecture.

---

## Dev Agent Record

**Agent Model Used:** Claude 3.5 Sonnet  
**Implementation Date:** August 31, 2025  
**Status:** Ready for Review

### Debug Log References
- All authentication endpoints implemented and tested
- Database models created with proper SQLAlchemy 2.x typing
- Comprehensive test suite covering unit and integration tests
- Email service configured for development and production
- Security measures implemented: Argon2 hashing, JWT tokens, rate limiting

### Completion Notes
- ✅ All 8 tasks completed successfully
- ✅ Application starts without errors
- ✅ Health check endpoint functional
- ✅ API documentation accessible at /docs
- ✅ Email service configured with console backend for development
- ✅ Redis session management implemented
- ✅ Comprehensive error handling and validation
- ✅ Security best practices implemented

### File List
**New Files Created:**
- `app/models/user.py` - User SQLAlchemy model with modern typing
- `app/schemas/auth.py` - Pydantic schemas for authentication
- `app/services/auth_service.py` - Authentication business logic service
- `app/core/security.py` - JWT utilities, password hashing, session management
- `app/core/email.py` - Email service for authentication emails
- `app/api/v1/auth.py` - Authentication API endpoints
- `app/templates/base.html` - Base HTML template with HTMX and Tailwind
- `app/templates/auth/login.html` - Login page template
- `app/templates/auth/register.html` - Registration page template  
- `app/templates/auth/forgot_password.html` - Password reset page template
- `alembic/versions/2e7b20c2a8c0_create_users_table.py` - Database migration
- `tests/test_auth_service.py` - Unit tests for authentication service
- `tests/test_auth_endpoints.py` - Integration tests for API endpoints
- `tests/test_security.py` - Security and validation tests

**Modified Files:**
- `app/main.py` - Added authentication router
- `app/core/config.py` - Enhanced with authentication settings
- `app/models/__init__.py` - Added User model export
- `app/schemas/__init__.py` - Added authentication schemas
- `app/services/__init__.py` - Created services package
- `app/api/__init__.py` - Created API package
- `app/api/v1/__init__.py` - Created v1 API package
- `tests/conftest.py` - Enhanced with auth fixtures and async support
- `alembic/env.py` - Configured for User model
- `.env.example` - Comprehensive environment configuration

### Change Log
1. **Database Layer**: Implemented User model with modern SQLAlchemy 2.x mapped_column syntax
2. **Security Layer**: Added Argon2 password hashing, JWT tokens, Redis session management, rate limiting
3. **API Layer**: Implemented 8 authentication endpoints with comprehensive error handling
4. **Frontend Layer**: Created responsive HTMX templates with client-side validation
5. **Service Layer**: Built authentication service with business logic separation
6. **Testing Layer**: Comprehensive unit and integration test coverage
7. **Configuration**: Enhanced settings for authentication, email, and security
8. **Email System**: Implemented development-friendly email service with HTML templates

**Dependencies Added:**
- `python-jose[cryptography]` - JWT token handling
- `passlib[argon2]` - Password hashing with Argon2
- `redis` - Session management and rate limiting
- `pydantic[email]` - Email validation
- `email-validator` - Email format validation
- `dnspython` - DNS resolution for email validation
